<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WARUNG I YOU</title>
  <style>
    body { font-family: 'Poppins', sans-serif; margin: 0; background: #f9fafc; color: #333; display: flex; flex-direction: column; height: 100vh; }
    header { padding: 15px; text-align: center; background: #2d89ef; color: white; font-size: 20px; font-weight: bold; flex-shrink: 0; }
    .content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 70px; }
    .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; display: flex; background: #fff; border-top: 1px solid #ddd; z-index: 100; }
    .tab-bar button { flex: 1; padding: 14px; font-size: 16px; border: none; background: none; cursor: pointer; font-weight: 500; }
    .tab-bar button.active { background: #2d89ef; color: white; }
    .hidden { display: none; }
    .bill-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 12px; box-shadow: 0 3px 8px rgba(0,0,0,0.08); }
    .menu-section { margin: 15px 0; }
    .menu-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
    .menu-buttons button { width:100%; padding:10px; border:none; border-radius:8px; background:#2d89ef; color:white; font-weight:600; cursor:pointer; }
    .menu-buttons button:hover { background:#1d5fad; }
    .total { font-weight: bold; margin-top: 12px; font-size: 16px; }
    .addon-popup, .drink-popup { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background:white; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.3); padding:20px; z-index: 200; display:none; width:300px; }
    .popup-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
    .popup-buttons button { padding:10px; border:none; border-radius:8px; font-weight:600; cursor:pointer; background:#2d89ef; color:white; }
    .popup-buttons button:hover { background:#1d5fad; }
    .popup-close { margin-top:10px; padding:8px; width:100%; background:#dc3545; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600; }
    input, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 15px; }
    button.confirm { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; background: #28a745; color: white; font-size: 16px; font-weight: 600; cursor: pointer; }
    button.confirm:hover { background: #1e7e34; }
    button.pay, button.edit { margin-top: 10px; padding: 10px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; width: 48%; }
    button.pay { background: #ffc107; color: #333; }
    button.pay:hover { background: #e0a800; }
    button.edit { background: #17a2b8; color: white; }
    button.edit:hover { background: #117a8b; }
    details summary { cursor: pointer; font-weight: bold; }
    .danger { background:#dc3545; color:white; padding:10px; border:none; border-radius:6px; margin-top:10px; cursor:pointer; width:100%; font-weight:600; }
    .danger:hover { background:#a71d2a; }
    .share-btn, .print-btn { margin-top: 10px; padding: 8px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; width: 48%; }
    .share-btn { background:#007bff; color:white; }
    .share-btn:hover { background:#0056b3; }
    .print-btn { background:#6c757d; color:white; }
    .print-btn:hover { background:#494f54; }
  </style>

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <header>WARUNG I YOU</header>

  <div class="content">
    <!-- Pesanan -->
    <div id="pesananTab" class="tab-content hidden">
      <h2>Pesanan Belum Dibayar</h2>
      <div id="pesananList"></div>
    </div>

    <!-- Selesai -->
    <div id="selesaiTab" class="tab-content hidden">
      <h2>Pesanan Selesai</h2>
      <div id="selesaiList"></div>
      <p class="total">Total Pemasukan: <span id="totalIncome">Rp0</span></p>
      <button onclick="testMidnight()" class="danger">TUTUP WARUNG</button>
    </div>

    <!-- Menu -->
    <div id="menuTab" class="tab-content">
      <h2>Buat Bill Baru</h2>
      <input type="text" id="billName" placeholder="Nama Bill (contoh: Meja 1)">
      
      <h3>Rincian Bill</h3>
      <ul id="billItems"></ul>
      <p class="total">Total: <span id="billTotal">Rp0</span></p>
      <button class="confirm" onclick="confirmBill()">Confirm Pesanan</button>

      <div class="menu-section">
        <h3>Makanan</h3>
    <button onclick="showAddon('Bakso Mie',10000)">Bakso Mie</button>
    <button onclick="showAddon('Bakso Kosong',8000)">Bakso Kosong</button>
    <button onclick="showAddon('Mie Ayam',10000)">Mie Ayam</button>
    <button onclick="showAddon('Mie Ayam Bakso',13000)">Mie Ayam Bakso</button>
    <button onclick="showAddon('Mie Sop Kampung',8000)">Mie Sop Kampung</button>
    <button onclick="showAddon('Nasi Goreng/Kampung',13000)">Nasi Goreng/Kampung</button>
    <button onclick="showAddon('Nasi Goreng Special',20000)">Nasi Goreng Special</button>
    <button onclick="showAddon('Nasi Ayam Penyet',15000)">Nasi Ayam Penyet</button>
    <button onclick="showAddon('Nasi Ayam Bakar',15000)">Nasi Ayam Bakar</button>
    <button onclick="showAddon('Nasi Ikan Nila Bakar',23000)">Nasi Ikan Nila Bakar</button>
    <button onclick="showAddon('Ifumie Goreng/Kuah',12000)">Ifumie Goreng/Kuah</button>
    <button onclick="showAddon('Mie Tiaw Goreng/Kuah',12000)">Mie Tiaw Goreng/Kuah</button>
    <button onclick="showAddon('Mie Kuning Goreng/Kuah',12000)">Mie Kuning Goreng/Kuah</button>
    <button onclick="showAddon('Mie Hun Goreng/Kuah',12000)">Mie Hun Goreng/Kuah</button>
    <button onclick="showAddon('Indomie Goreng/Kuah',12000)">Indomie Goreng/Kuah</button>
    <button onclick="showAddon('Pecel Lele',15000)">Pecel Lele</button>
    <button onclick="showAddon('Tempe Goreng',10000)">Tempe Goreng</button>
    <button onclick="showAddon('Nugget',10000)">Nugget</button>
        </div>
      </div>

      <div class="menu-section">
        <h3>Minuman</h3>
        <div class="menu-buttons" id="drinkButtons">
         <button onclick="showAddon('Bakso Mie',10000)">Bakso Mie</button>
    <button onclick="showAddon('Bakso Kosong',8000)">Bakso Kosong</button>
    <button onclick="showAddon('Mie Ayam',10000)">Mie Ayam</button>
    <button onclick="showAddon('Mie Ayam Bakso',13000)">Mie Ayam Bakso</button>
    <button onclick="showAddon('Mie Sop Kampung',8000)">Mie Sop Kampung</button>
    <button onclick="showAddon('Nasi Goreng/Kampung',13000)">Nasi Goreng/Kampung</button>
    <button onclick="showAddon('Nasi Goreng Special',20000)">Nasi Goreng Special</button>
    <button onclick="showAddon('Nasi Ayam Penyet',15000)">Nasi Ayam Penyet</button>
    <button onclick="showAddon('Nasi Ayam Bakar',15000)">Nasi Ayam Bakar</button>
    <button onclick="showAddon('Nasi Ikan Nila Bakar',23000)">Nasi Ikan Nila Bakar</button>
    <button onclick="showAddon('Ifumie Goreng/Kuah',12000)">Ifumie Goreng/Kuah</button>
    <button onclick="showAddon('Mie Tiaw Goreng/Kuah',12000)">Mie Tiaw Goreng/Kuah</button>
    <button onclick="showAddon('Mie Kuning Goreng/Kuah',12000)">Mie Kuning Goreng/Kuah</button>
    <button onclick="showAddon('Mie Hun Goreng/Kuah',12000)">Mie Hun Goreng/Kuah</button>
    <button onclick="showAddon('Indomie Goreng/Kuah',12000)">Indomie Goreng/Kuah</button>
    <button onclick="showAddon('Pecel Lele',15000)">Pecel Lele</button>
    <button onclick="showAddon('Tempe Goreng',10000)">Tempe Goreng</button>
    <button onclick="showAddon('Nugget',10000)">Nugget</button>
        </div>
      </div>
    </div>

    <!-- History -->
    <div id="historyTab" class="tab-content hidden">
      <h2>History Pesanan</h2>
      <label>Pilih tanggal awal</label>
      <input type="date" id="startDate">
      <label>Pilih tanggal akhir</label>
      <input type="date" id="endDate">
      <button onclick="showHistory()">Tampilkan History</button>
      <button onclick="showTopMenu()">⭐ Top Menu</button>
      <div id="historyList"></div>
      <button onclick="clearAll()" class="danger">Clear All</button>
    </div>
  </div>

  <!-- Tab Navigasi -->
  <div class="tab-bar">
    <button class="active" onclick="showTab('menuTab', this)">Menu</button>
    <button onclick="showTab('pesananTab', this)">Pesanan</button>
    <button onclick="showTab('selesaiTab', this)">Selesai</button>
    <button onclick="showTab('historyTab', this)">History</button>
  </div>

  <!-- Popups -->
  <div class="addon-popup" id="addonPopup">
    <h3 id="addonTitle">Tambah Add-on</h3>
    <div class="popup-buttons" id="addonOptions"></div>
    <button class="popup-close" onclick="closeAddon()">Batal</button>
  </div>

  <div class="drink-popup" id="drinkPopup">
    <h3 id="drinkTitle">Pilih Panas/Dingin</h3>
    <div class="popup-buttons">
      <button onclick="chooseDrink('normal')">Normal</button>
      <button onclick="chooseDrink('panas')">Panas (-1000)</button>
      <button onclick="chooseDrink('dingin')">Dingin (+1000)</button>
    </div>
    <button class="popup-close" onclick="closeDrink()">Batal</button>
  </div>

  <script>
    function formatRupiah(num) {
      return "Rp" + num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    let currentBill = { name: "", items: [], total: 0 };
    let pesanan = JSON.parse(localStorage.getItem("pesanan")) || [];
    let selesai = JSON.parse(localStorage.getItem("selesai")) || [];
    let totalIncome = parseInt(localStorage.getItem("totalIncome")) || 0;
    let history = JSON.parse(localStorage.getItem("history")) || [];

    let tempItem = null;

    function saveData() {
      localStorage.setItem("pesanan", JSON.stringify(pesanan));
      localStorage.setItem("selesai", JSON.stringify(selesai));
      localStorage.setItem("totalIncome", totalIncome);
      localStorage.setItem("history", JSON.stringify(history));
    }

    function addItem(name, price) {
      let item = currentBill.items.find(i => i.name === name);
      if (item) { item.qty++; } else { currentBill.items.push({ name, price, qty: 1 }); }
      calculateTotal();
      renderBillItems();
    }

    function calculateTotal() {
      currentBill.total = currentBill.items.reduce((sum, i) => sum + i.price * i.qty, 0);
    }

    function renderBillItems() {
      const billItems = document.getElementById("billItems");
      billItems.innerHTML = "";
      currentBill.items.forEach((item, idx) => {
        const li = document.createElement("li");
        li.innerHTML = `
          ${item.name} (x${item.qty}) - ${formatRupiah(item.price * item.qty)}
          <button style="margin-left:10px;color:red;" onclick="removeOne(${idx})">❌</button>
        `;
        billItems.appendChild(li);
      });
      document.getElementById("billTotal").innerText = formatRupiah(currentBill.total);
    }

    function removeOne(index) {
      if (currentBill.items[index].qty > 1) {
        currentBill.items[index].qty--;
      } else {
        currentBill.items.splice(index,1);
      }
      calculateTotal();
      renderBillItems();
    }

    function confirmBill() {
      const name = document.getElementById("billName").value.trim();
      if (!name) return alert("Masukkan nama bill (contoh: Meja 1)");
      if (currentBill.items.length === 0) return alert("Tambahkan minimal 1 item menu");
      
      currentBill.name = name;
      currentBill.time = new Date().toLocaleString("id-ID");
      pesanan.push(JSON.parse(JSON.stringify(currentBill)));
      saveData();

      currentBill = { name: "", items: [], total: 0 };
      document.getElementById("billName").value = "";
      renderBillItems();
      renderPesanan();
      showTab('pesananTab', document.querySelectorAll(".tab-bar button")[1]);
    }

    function renderPesanan() {
      const container = document.getElementById("pesananList");
      container.innerHTML = "";
      pesanan.forEach((bill, index) => {
        const card = document.createElement("div");
        card.className = "bill-card";
        card.innerHTML = `
          <h3>${bill.name}</h3>
          <ul>${bill.items.map(i=>`<li>${i.name} x${i.qty} - ${formatRupiah(i.price*i.qty)}</li>`).join("")}</ul>
          <p class="total">Total: ${formatRupiah(bill.total)}</p>
          <div style="display:flex; gap:4%">
            <button class="edit" onclick="editBill(${index})">Edit</button>
            <button class="pay" onclick="bayar(${index})">Bayar</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function editBill(index) {
      currentBill = {...pesanan[index]};
      currentBill.items = [...pesanan[index].items];
      pesanan.splice(index,1);
      saveData();
      renderBillItems();
      document.getElementById("billName").value = currentBill.name;
      showTab('menuTab', document.querySelectorAll(".tab-bar button")[0]);
    }

    function bayar(index) {
      const bill = pesanan.splice(index,1)[0];
      selesai.push(bill);
      totalIncome += bill.total;
      saveData();
      renderPesanan();
      renderSelesai();
    }

    function renderSelesai() {
      const container = document.getElementById("selesaiList");
      container.innerHTML = "";
      selesai.forEach((bill, idx) => {
        const details = document.createElement("details");
        details.className = "bill-card";
        details.innerHTML = `
          <summary>${bill.name} - ${bill.time}</summary>
          <ul>${bill.items.map(i=>`<li>${i.name} x${i.qty} - ${formatRupiah(i.price*i.qty)}</li>`).join("")}</ul>
          <p class="total">Total: ${formatRupiah(bill.total)}</p>
          <div style="display:flex; gap:4%">
            <button class="share-btn" onclick="downloadBill(${idx})">Download Bill</button>
            <button class="print-btn" onclick="printBill(${idx})">Print Bill</button>
          </div>
        `;
        container.appendChild(details);
      });
      document.getElementById("totalIncome").innerText = formatRupiah(totalIncome);
    }

    // Add-on makanan
    function showAddon(name, price) {
      tempItem = { name, price, addons: [], qty: 1 };
      document.getElementById("addonTitle").innerText = `Tambah Add-on untuk ${name}`;
      const container = document.getElementById("addonOptions");
      container.innerHTML = "";
      ["Nasi +3000","Telur +2000","Ayam +5000"].forEach(addon => {
        const btn = document.createElement("button");
        btn.innerText = addon;
        btn.onclick = () => {
          const split = addon.split(" +");
          tempItem.addons.push({ name: split[0], price: parseInt(split[1]) });
        };
        container.appendChild(btn);
      });
      const addBtn = document.createElement("button");
      addBtn.innerText = "Tambah ke Bill";
      addBtn.onclick = () => {
        let totalPrice = tempItem.price + tempItem.addons.reduce((s,a)=>s+a.price,0);
        currentBill.items.push({ name: tempItem.name + (tempItem.addons.length>0? " ("+tempItem.addons.map(a=>a.name).join(", ")+")": ""), price: totalPrice, qty: 1 });
        calculateTotal();
        renderBillItems();
        closeAddon();
      };
      container.appendChild(addBtn);
      document.getElementById("addonPopup").style.display = "block";
    }

    function closeAddon() {
      document.getElementById("addonPopup").style.display = "none";
      tempItem = null;
    }

    // Minuman panas/dingin
    function showDrink(name, price) {
      tempItem = { name, price, qty: 1 };
      document.getElementById("drinkTitle").innerText = `Pilih Panas/Dingin untuk ${name}`;
      document.getElementById("drinkPopup").style.display = "block";
    }

    function chooseDrink(option) {
      let price = tempItem.price;
      if(option==="panas") price -= 1000;
      if(option==="dingin") price += 1000;
      currentBill.items.push({ name: tempItem.name + (option!=="normal"? ` (${option})` : ""), price: price, qty: 1 });
      calculateTotal();
      renderBillItems();
      closeDrink();
    }

    function closeDrink() {
      document.getElementById("drinkPopup").style.display = "none";
      tempItem = null;
    }

    // Fungsi Download Bill dengan html2canvas
    function downloadBill(index) {
  const bill = selesai[index];

  // Buat container sementara untuk bill
  const tempDiv = document.createElement("div");
  tempDiv.style.position = "fixed";
  tempDiv.style.left = "-9999px"; // sembunyikan
  tempDiv.innerHTML = `
    <div style="width:350px; font-family: Arial, sans-serif; font-size:14px; background:white; padding:15px;">
      <div style="text-align:center;">
        <img src="https://raw.githubusercontent.com/Bardenss/Waroeng-i-you/main/Logo.png" width="80"><br>
        <b>PONDOK KULINER I YOU</b><br>
        Jl, Namu Ukur - Telagah - Tanjung Karo<br>
        Telp: 082164753151<br>
      </div>
      <hr style="border-top:1px dashed #000; margin:8px 0;">
      <p>Tanggal: ${bill.time}</p>
      <p>No Bill: ${bill.name}</p>
      <hr style="border-top:1px dashed #000; margin:8px 0;">
      <ul style="list-style:none; padding:0; margin:0;">
        ${bill.items.map((i, idx) => `
          <li>${idx+1}. ${i.name}<br>
              ${i.qty} x ${formatRupiah(i.price)} 
              <span style="float:right;">${formatRupiah(i.price*i.qty)}</span>
          </li>
        `).join("")}
      </ul>
      <hr style="border-top:1px dashed #000; margin:8px 0;">
      <p><b>Total Qty:</b> ${bill.items.reduce((sum,i)=>sum+i.qty,0)}</p>
      <p><b>Sub Total:</b> ${formatRupiah(bill.total)}</p>
      <p style="font-weight:bold;">Total: ${formatRupiah(bill.total)}</p>
      <p>Bayar (Cash): ${formatRupiah(bill.total)}</p>
      <p>Kembali: Rp0</p>
      <hr style="border-top:1px dashed #000; margin:8px 0;">
      <p style="text-align:center;">Terimakasih Telah Berbelanja</p>
    </div>
  `;

  document.body.appendChild(tempDiv);

  html2canvas(tempDiv).then(canvas => {
    const link = document.createElement("a");
    link.download = `Bill-${index+1}.png`;
    link.href = canvas.toDataURL();
    link.click();
    document.body.removeChild(tempDiv); // hapus container sementara
  });
}

    // Cetak bill
    function printBill(index) {
      const bill = selesai[index];
      let printWindow = window.open("", "_blank");
      printWindow.document.write(`
        <html>
        <head>
          <title>Bill - ${bill.name}</title>
          <style>
            body { font-family: Arial, sans-serif; font-size:14px; }
            .center { text-align:center; }
            .line { border-top:1px dashed #000; margin:8px 0; }
            ul { list-style:none; padding:0; margin:0; }
            li { margin:4px 0; }
            .total { font-weight:bold; font-size:16px; margin-top:10px; }
          </style>
        </head>
        <body>
          <div class="center">
            <img src="https://raw.githubusercontent.com/Bardenss/Waroeng-i-you/main/Logo.png" width="80"><br>
            <b>PONDOK KULINER I YOU</b><br>
            Jl, Namu Ukur - Telagah - Tanjung Karo<br>
            Telp: 082164753151<br>
          </div>
          <div class="line"></div>
          <p>Tanggal: ${bill.time}</p>
          <p>No Bill: ${bill.name}</p>
          <div class="line"></div>
          <ul>
            ${bill.items.map((i, idx)=>`
              <li>${idx+1}. ${i.name}<br>
                  ${i.qty} x ${formatRupiah(i.price)} 
                  <span style="float:right;">${formatRupiah(i.price*i.qty)}</span>
              </li>
            `).join("")}
          </ul>
          <div class="line"></div>
          <p><b>Total Qty:</b> ${bill.items.reduce((sum,i)=>sum+i.qty,0)}</p>
          <p><b>Sub Total:</b> ${formatRupiah(bill.total)}</p>
          <p class="total">Total: ${formatRupiah(bill.total)}</p>
          <p>Bayar (Cash): ${formatRupiah(bill.total)}</p>
          <p>Kembali: Rp0</p>
          <div class="line"></div>
          <p class="center">Terimakasih Telah Berbelanja</p>
        </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }

    function testMidnight() { resetMidnight(); }

    function resetMidnight() {
      if (selesai.length > 0) {
        history.push({ date: new Date().toLocaleDateString("id-ID"), bills: selesai });
      }
      selesai = [];
      totalIncome = 0;
      saveData();
      renderSelesai();
    }

    function showHistory() {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      if (!start || !end) return alert("Pilih tanggal awal dan akhir");
      const sDate = new Date(start);
      const eDate = new Date(end);
      const container = document.getElementById("historyList");
      container.innerHTML = "";
      history.forEach(day => {
        const d = new Date(day.date.split("/").reverse().join("-"));
        if (d >= sDate && d <= eDate) {
          const card = document.createElement("div");
          card.className = "bill-card";
          card.innerHTML = `<h3>${day.date}</h3>` + day.bills.map(bill => `
            <p><b>${bill.name}</b> (${bill.time}) - ${formatRupiah(bill.total)}</p>
          `).join("");
          container.appendChild(card);
        }
      });
    }

    function showTopMenu() {
      let counts = {};
      history.forEach(day => {
        day.bills.forEach(bill => {
          bill.items.forEach(i => {
            if (!counts[i.name]) counts[i.name] = { qty: 0, total: 0 };
            counts[i.name].qty += i.qty;
            counts[i.name].total += i.price * i.qty;
          });
        });
      });
      let sorted = Object.entries(counts).sort((a,b)=>b[1].qty-a[1].qty);
      const container = document.getElementById("historyList");
      container.innerHTML = "<h3>Top Menu</h3>" + sorted.map(([name, data]) =>
        `<p>${name}: ${data.qty}x - ${formatRupiah(data.total)}</p>`).join("");
    }

    function clearAll() {
      let pin = prompt("Masukkan PIN untuk konfirmasi:");
      if (pin !== "0000") return alert("PIN salah!");
      pesanan=[]; selesai=[]; history=[]; totalIncome=0; saveData();
      renderPesanan(); renderSelesai();
      document.getElementById("historyList").innerHTML="";
      alert("Semua data berhasil dihapus!");
    }

    function showTab(tabId, btn) {
      document.querySelectorAll(".tab-content").forEach(tab => tab.classList.add("hidden"));
      document.getElementById(tabId).classList.remove("hidden");
      document.querySelectorAll(".tab-bar button").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
    }

    renderPesanan();
    renderSelesai();
  </script>
</body>
</html>